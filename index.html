<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniHide - Secure Steganography</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #0f172a; --card-bg: rgba(30, 41, 59, 0.7); --primary: #3b82f6; --accent: #10b981; --text-main: #f8fafc; --text-muted: #94a3b8; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #020617 100%); color: var(--text-main); min-height: 100vh; display: flex; justify-content: center; align-items: center; margin: 0; overflow: hidden; }
        .glow { position: absolute; width: 300px; height: 300px; background: var(--primary); filter: blur(150px); border-radius: 50%; opacity: 0.2; animation: float 6s infinite alternate; z-index: -1; }
        .glow:nth-child(2) { right: 10%; bottom: 10%; background: var(--accent); animation-delay: -3s; }
        @keyframes float { 0% { transform: translateY(0px) scale(1); } 100% { transform: translateY(-30px) scale(1.1); } }
        
        .app-container { background: var(--card-bg); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 40px; width: 100%; max-width: 480px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { font-weight: 800; font-size: 28px; margin: 0; background: linear-gradient(to right, #60a5fa, #34d399); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header p { color: var(--text-muted); font-size: 14px; margin-top: 5px; }
        
        /* LOGIN SCREEN STYLES */
        #login-screen { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-btn { width: 100%; background: white; color: #333; border: none; padding: 12px 24px; font-size: 15px; font-weight: 600; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; margin-bottom: 15px; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 255, 255, 0.2); }
        .login-btn img { width: 20px; height: 20px; }
        
        .divider { display: flex; align-items: center; text-align: center; color: var(--text-muted); font-size: 12px; margin: 15px 0; width: 100%; }
        .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .divider:not(:empty)::before { margin-right: .5em; }
        .divider:not(:empty)::after { margin-left: .5em; }

        .phone-group { width: 100%; display: flex; gap: 10px; margin-bottom: 15px; }
        .phone-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); color: white; outline: none; }
        .action-btn-sm { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .action-btn-sm:hover { background: #2563eb; }

        /* MAIN APP STYLES (Hidden by default) */
        #main-app { display: none; }
        .user-panel { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); padding: 10px 15px; border-radius: 12px; margin-bottom: 25px; font-size: 13px; }
        .logout-btn { background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; }

        .tabs { display: flex; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 5px; margin-bottom: 25px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; color: var(--text-muted); font-weight: 600; cursor: pointer; border-radius: 8px; transition: 0.3s; font-size: 14px; }
        .tab-btn.active { background: var(--primary); color: white; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; }
        select, input[type="text"] { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: white; font-size: 14px; box-sizing: border-box; outline: none; }
        .file-upload-wrapper { position: relative; width: 100%; height: 120px; border: 2px dashed rgba(255,255,255,0.2); border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.1); cursor: pointer; margin-bottom: 20px; }
        .file-upload-wrapper input[type="file"] { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .file-name { font-size: 13px; color: var(--primary); font-weight: 600; margin-top: 8px; display: none; }
        .action-btn { width: 100%; padding: 16px; border: none; border-radius: 12px; background: linear-gradient(135deg, var(--primary) 0%, #2563eb 100%); color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.3s; display: flex; justify-content: center; gap: 10px; }
        .status-box { margin-top: 20px; padding: 15px; border-radius: 12px; font-size: 14px; display: none; text-align: left; background: rgba(0,0,0,0.3); border-left: 4px solid var(--primary); word-wrap: break-word; }
        .status-box.success { border-color: var(--accent); }
        .status-box.error { border-color: #ef4444; }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid white; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .decoded-text { font-family: 'Fira Code', monospace; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 8px; margin-top: 10px; color: #34d399; }
        #recaptcha-container { margin-top: 10px; }
    </style>
</head>
<body>

<div class="glow"></div><div class="glow"></div>

<div class="app-container">
    <div class="header">
        <h1>OmniHide Pro</h1>
        <p>Enterprise Multimedia Steganography</p>
    </div>

    <div id="login-screen">
        <h3 style="margin-bottom: 20px; color: #e2e8f0; font-weight: 400;">Secure Authentication</h3>
        
        <button class="login-btn" onclick="googleLogin()">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google">
            Sign in with Google
        </button>

        <div class="divider">OR USE PHONE NUMBER</div>

        <div id="phone-box" class="phone-group">
            <input type="text" id="phoneNumber" placeholder="+91 9876543210" value="+91">
            <button class="action-btn-sm" onclick="sendOTP()">Get OTP</button>
        </div>

        <div id="otp-box" class="phone-group" style="display: none;">
            <input type="text" id="otpCode" placeholder="Enter 6-digit OTP">
            <button class="action-btn-sm" style="background: var(--accent);" onclick="verifyOTP()">Verify</button>
        </div>

        <div id="recaptcha-container"></div>
        <p id="auth-status" style="color: #ef4444; font-size: 12px; margin-top: 10px;"></p>
    </div>

    <div id="main-app">
        <div class="user-panel">
            <span id="welcome-text" style="color: #34d399; font-weight: 600;">Welcome, Agent</span>
            <button class="logout-btn" onclick="logoutUser()">Logout</button>
        </div>
        
        <div class="tabs">
            <button id="tab-encode" class="tab-btn active" onclick="switchMode('encode')">üîí ENCRYPT</button>
            <button id="tab-decode" class="tab-btn" onclick="switchMode('decode')">üîì DECRYPT</button>
        </div>
        <div class="input-group">
            <label>Media Format</label>
            <select id="mediaType" onchange="updateAccept()">
                <option value="image">üñºÔ∏è Image (.png, .jpg)</option>
                <option value="audio">üéµ Audio (.wav)</option>
                <option value="video">üé¨ Video (.avi, .mp4)</option>
            </select>
        </div>
        <div class="file-upload-wrapper" id="dropZone">
            <span id="uploadText" style="color: var(--text-muted); font-size: 14px;">Click to browse file</span>
            <span class="file-name" id="fileNameDisplay">No file selected</span>
            <input type="file" id="fileInput" onchange="showFileName()">
        </div>
        <div class="input-group" id="secretBox">
            <label>Secret Payload</label>
            <input type="text" id="secretText" placeholder="Enter classified text...">
        </div>
        <button class="action-btn" id="actionBtn" onclick="process()">
            <span id="btnText">Initialize Encryption</span>
            <div class="loader" id="loader"></div>
        </button>
        <div id="statusBox" class="status-box"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCFVlXWKVSJEw6OfWbP5mP5i2Kui-B4qgY",
      authDomain: "omnihide-2da3c.firebaseapp.com",
      projectId: "omnihide-2da3c",
      storageBucket: "omnihide-2da3c.firebasestorage.app",
      messagingSenderId: "264406536701",
      appId: "1:264406536701:web:4789bbac1a0d291573c994"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Check if user is logged in
    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            let displayName = user.displayName ? user.displayName.split(' ')[0] : user.phoneNumber;
            document.getElementById('welcome-text').innerText = `Welcome, ${displayName}`;
        } else {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
        }
    });

    // Google Login
    window.googleLogin = () => {
        signInWithPopup(auth, provider).catch(error => alert("Login Failed: " + error.message));
    };

    window.logoutUser = () => signOut(auth);

    // --- PHONE AUTHENTICATION LOGIC ---
    // Recaptcha setup karna zaroori hai spam rokne ke liye
    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
        'size': 'invisible',
        'callback': (response) => { console.log("Recaptcha solved"); }
    });

    window.sendOTP = () => {
        const phoneNumber = document.getElementById('phoneNumber').value;
        const statusText = document.getElementById('auth-status');
        
        if(phoneNumber.length < 12) {
            statusText.innerText = "Please enter valid number with country code (e.g. +91...)";
            return;
        }
        
        statusText.innerText = "Sending OTP... Please wait.";
        statusText.style.color = "#34d399"; // Green

        const appVerifier = window.recaptchaVerifier;
        signInWithPhoneNumber(auth, phoneNumber, appVerifier)
            .then((confirmationResult) => {
                window.confirmationResult = confirmationResult;
                document.getElementById('phone-box').style.display = 'none';
                document.getElementById('otp-box').style.display = 'flex';
                statusText.innerText = "OTP Sent Successfully!";
            }).catch((error) => {
                statusText.innerText = "Error: " + error.message;
                statusText.style.color = "#ef4444"; // Red
            });
    };

    window.verifyOTP = () => {
        const code = document.getElementById('otpCode').value;
        const statusText = document.getElementById('auth-status');
        
        window.confirmationResult.confirm(code).then((result) => {
            // Success! onAuthStateChanged will automatically show the Main App
        }).catch((error) => {
            statusText.innerText = "Invalid OTP! Please try again.";
            statusText.style.color = "#ef4444";
        });
    };
</script>

<script>
    let mode = 'encode';
    function switchMode(newMode) {
        mode = newMode;
        document.getElementById('tab-encode').classList.toggle('active', mode === 'encode');
        document.getElementById('tab-decode').classList.toggle('active', mode === 'decode');
        document.getElementById('secretBox').style.display = mode === 'encode' ? 'block' : 'none';
        document.getElementById('btnText').innerText = mode === 'encode' ? 'Initialize Encryption' : 'Run Decryption Protocol';
        document.getElementById('statusBox').style.display = 'none';
        updateAccept();
    }
    function updateAccept() {
        const type = document.getElementById('mediaType').value;
        const input = document.getElementById('fileInput');
        if (mode === 'encode') {
            if (type === 'image') input.accept = '.png, .jpg, .jpeg';
            if (type === 'audio') input.accept = '.wav';
            if (type === 'video') input.accept = '.avi, .mp4, .mkv';
        } else {
            if (type === 'image') input.accept = '.png';
            if (type === 'audio') input.accept = '.wav';
            if (type === 'video') input.accept = '.avi';
        }
    }
    function showFileName() {
        const file = document.getElementById('fileInput').files[0];
        if (file) {
            document.getElementById('uploadText').style.display = 'none';
            document.getElementById('fileNameDisplay').style.display = 'block';
            document.getElementById('fileNameDisplay').innerText = "üìÅ " + file.name;
        }
    }
    function showStatus(message, type) {
        const box = document.getElementById('statusBox');
        box.style.display = 'block';
        box.className = `status-box ${type}`;
        box.innerHTML = message;
    }
    async function process() {
        const file = document.getElementById('fileInput').files[0];
        const type = document.getElementById('mediaType').value;
        const btnText = document.getElementById('btnText');
        const loader = document.getElementById('loader');

        if (!file) return showStatus("‚ö†Ô∏è Authorization failed: No carrier file selected.", "error");

        const formData = new FormData();
        formData.append("file", file);
        if (mode === 'encode') {
            const text = document.getElementById('secretText').value;
            if (!text) return showStatus("‚ö†Ô∏è Authorization failed: Secret payload cannot be empty.", "error");
            formData.append("secret_text", text);
        }

        btnText.innerText = mode === 'encode' ? 'Encrypting Data...' : 'Extracting Data...';
        loader.style.display = 'block';
        document.getElementById('actionBtn').style.opacity = '0.7';
        document.getElementById('statusBox').style.display = 'none';

        try {
            const url = `https://omnihide-backend.onrender.com/${mode}/${type}/`;
            const response = await fetch(url, { method: 'POST', body: formData });

            if (mode === 'encode') {
                if (response.ok) {
                    const blob = await response.blob();
                    const link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    let ext = type === 'image' ? '.png' : type === 'audio' ? '.wav' : '.avi';
                    link.download = `OmniHide_Secure_${type}${ext}`;
                    link.click();
                    showStatus(`‚úÖ <b>Success:</b> Data secured! File saved as <b>${ext}</b>.`, "success");
                } else {
                    showStatus("‚ùå <b>Error:</b> Server rejected the request.", "error");
                }
            } else {
                const result = await response.json();
                if (result.status === "success") {
                    showStatus(`üîì <b>Decryption Successful:</b><div class="decoded-text">${result.secret_message}</div>`, "success");
                } else {
                    showStatus(`‚ùå <b>Decryption Failed:</b> ${result.message}`, "error");
                }
            }
        } catch (error) {
            showStatus("‚ùå <b>Network Error:</b> Ensure backend server is running.", "error");
        }

        btnText.innerText = mode === 'encode' ? 'Initialize Encryption' : 'Run Decryption Protocol';
        loader.style.display = 'none';
        document.getElementById('actionBtn').style.opacity = '1';
    }
</script>

</body>
</html>